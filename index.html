<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAVE CAVE üç∑‚ö°</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --neon-pink: #FF006E; --hot-pink: #FF1B8D; --watermelon: #FF2E63;
            --acid-green: #CCFF00; --electric-lime: #39FF14; --electric-white: #FFFFFF;
            --warm-beige: #F5E6D3; --pure-black: #000000; --dark-grey: #1A1A1A;
        }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--warm-beige); overflow-x: hidden; color: var(--pure-black); }
        .font-display { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.02em; }
        .font-mono { font-family: 'IBM Plex Mono', monospace; }
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: var(--pure-black); }
        ::-webkit-scrollbar-thumb { background: var(--acid-green); border: 2px solid var(--pure-black); }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-pink); }
        .neon-glow-pink { box-shadow: 0 0 20px rgba(255, 0, 110, 0.5), 0 0 40px rgba(255, 0, 110, 0.3); }
        .neon-glow-green { box-shadow: 0 0 20px rgba(204, 255, 0, 0.6), 0 0 40px rgba(204, 255, 0, 0.3); }
        .text-glow-pink { text-shadow: 0 0 10px rgba(255, 0, 110, 0.8), 0 0 20px rgba(255, 0, 110, 0.4); }
        .text-glow-green { text-shadow: 0 0 10px rgba(204, 255, 0, 0.9), 0 0 20px rgba(204, 255, 0, 0.5); }
        .clip-diagonal { clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); }
        .sticker-badge { transform: rotate(-2deg); transition: transform 0.2s ease; }
        .sticker-badge:hover { transform: rotate(2deg) scale(1.05); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }

        /* CHAT WIDGET STYLES */
        .chat-widget { position: fixed; bottom: 24px; right: 24px; z-index: 100; font-family: 'Space Grotesk', sans-serif; }
        .chat-bubble { width: 64px; height: 64px; background: var(--neon-pink); border: 4px solid var(--pure-black); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(255, 0, 110, 0.5); }
        .chat-bubble:hover { background: var(--acid-green); transform: rotate(5deg) scale(1.1); }
        .chat-window { position: fixed; bottom: 24px; right: 24px; width: 400px; height: 600px; max-width: calc(100vw - 48px); max-height: calc(100vh - 48px); background: var(--warm-beige); border: 8px solid var(--pure-black); display: flex; flex-direction: column; box-shadow: 0 0 40px rgba(0, 0, 0, 0.5); }
        .chat-header { background: var(--pure-black); color: var(--acid-green); padding: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--neon-pink); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 12px 16px; border: 3px solid var(--pure-black); max-width: 80%; word-wrap: break-word; }
        .chat-message.user { background: var(--neon-pink); color: white; align-self: flex-end; margin-left: auto; }
        .chat-message.bot { background: var(--acid-green); color: var(--pure-black); align-self: flex-start; }
        .chat-message.loading { background: var(--electric-white); border-style: dashed; font-family: 'IBM Plex Mono', monospace; text-align: center; }
        .chat-input-area { padding: 16px; background: var(--pure-black); border-top: 4px solid var(--neon-pink); display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 12px; border: 3px solid var(--acid-green); background: var(--pure-black); color: var(--acid-green); font-family: 'IBM Plex Mono', monospace; font-size: 14px; }
        .chat-input:focus { outline: none; border-color: var(--neon-pink); }
        .chat-send-btn { padding: 12px 20px; background: var(--acid-green); border: 3px solid var(--pure-black); color: var(--pure-black); font-family: 'Bebas Neue', sans-serif; font-size: 18px; cursor: pointer; transition: all 0.2s ease; }
        .chat-send-btn:hover { background: var(--neon-pink); color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICON COMPONENTS ---
        const WineIcon = ({ className = "w-8 h-8", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <path strokeLinecap="square" strokeLinejoin="miter" d="M9 2h6v7c0 3.5-2.5 6-6 6s-6-2.5-6-6V2m0 13h12M7 22h10" />
            </svg>
        );
        const SearchIcon = ({ className = "w-5 h-5", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <circle cx="11" cy="11" r="8" />
                <path strokeLinecap="square" d="M21 21l-4.35-4.35" />
            </svg>
        );
        const FilterIcon = ({ className = "w-5 h-5", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <path strokeLinecap="square" d="M3 4h18M3 12h12M3 20h6" />
            </svg>
        );
        const ChevronIcon = ({ className = "w-5 h-5", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <path strokeLinecap="square" d="M19 9l-7 7-7-7" />
            </svg>
        );
        const StarIcon = ({ className = "w-4 h-4", style }) => (
            <svg className={className} fill="currentColor" viewBox="0 0 24 24" style={style}>
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
            </svg>
        );
        const ClockIcon = ({ className = "w-4 h-4", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <circle cx="12" cy="12" r="10" />
                <path strokeLinecap="square" d="M12 6v6l4 2" />
            </svg>
        );
        const XIcon = ({ className = "w-6 h-6", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={4} style={style}>
                <path strokeLinecap="square" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const ChatIcon = ({ className = "w-8 h-8", style }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth={3} style={style}>
                <path strokeLinecap="square" strokeLinejoin="miter" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        );

        // --- CHAT WIDGET COMPONENT ---
        const ChatWidget = () => {
          const [isOpen, setIsOpen] = useState(false);
          const [messages, setMessages] = useState([{ type: 'bot', text: 'üç∑ Hey! I\'m your sommelier. Ask me anything about your cellar!' }]);
          const [input, setInput] = useState('');
          const [loading, setLoading] = useState(false);
          const [geminiHistory, setGeminiHistory] = useState([]);
          const messagesEndRef = useRef(null);

          const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxHdT1uvpWhl9jiPP54jyzXddJTVoNnxjYPPyYpjC7agDCVSzcyLx89Wjt1NHqHKI4I/exec';

          useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

          const sendMessage = async () => {
            if (!input.trim() || loading) return;
            const userText = input.trim();
            setInput('');
            setMessages(prev => [...prev, { type: 'user', text: userText }]);
            const updatedHistory = [...geminiHistory, { role: 'user', parts: [{ text: userText }] }];
            setLoading(true);
            try {
              const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ history: updatedHistory })
              });
              const data = await response.json();
              const botReply = data.response || "Pardon, I missed that.";
              setMessages(prev => [...prev, { type: 'bot', text: botReply }]);
              setGeminiHistory([...updatedHistory, { role: 'model', parts: [{ text: botReply }] }]);
            } catch (error) {
              setMessages(prev => [...prev, { type: 'bot', text: `‚ö†Ô∏è Error: ${error.message}` }]);
            } finally { setLoading(false); }
          };

          if (!isOpen) return (
            <div className="chat-widget">
              <div className="chat-bubble" onClick={() => setIsOpen(true)}>
                <ChatIcon style={{color: '#CCFF00'}} />
              </div>
            </div>
          );

          return (
            <div className="chat-widget">
              <div className="chat-window">
                <div className="chat-header">
                  <h3 className="font-display text-2xl">SOMMELIER AI</h3>
                  <button onClick={() => setIsOpen(false)}><XIcon style={{color: '#CCFF00'}} className="w-5 h-5" /></button>
                </div>
                <div className="chat-messages">
                  {messages.map((msg, i) => <div key={i} className={`chat-message ${msg.type}`}>{msg.text}</div>)}
                  {loading && <div className="chat-message loading">THINKING...</div>}
                  <div ref={messagesEndRef} />
                </div>
                <div className="chat-input-area">
                  <input className="chat-input" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && sendMessage()} placeholder="ASK ABOUT WINE..." disabled={loading} />
                  <button className="chat-send-btn" onClick={sendMessage} disabled={loading}>SEND</button>
                </div>
              </div>
            </div>
          );
        };

        // --- MAIN APPLICATION ---
        const RaveCave = () => {
          const [wines, setWines] = useState([]);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [searchTerm, setSearchTerm] = useState('');
          const [sidebarOpen, setSidebarOpen] = useState(true);
          const [selectedWine, setSelectedWine] = useState(null);
          const [filters, setFilters] = useState({ vintage: [], wineType: [], cepage: [], appellation: [], region: [], country: [], maturity: [], vivinoRating: false });

          const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTC05_L-VtjWBWlHZWrpc9UKfe7H-vKJPn08dAwqDOaZn7bocarcs3rUtUorGeYQXGNwKwVGPVsMzL4/pub?output=csv';

          useEffect(() => { fetchWineData(); }, []);

          const fetchWineData = async () => {
            try {
              const response = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(CSV_URL));
              const csvText = await response.text();
              window.Papa.parse(csvText, {
                header: true, skipEmptyLines: true,
                complete: (results) => { setWines(results.data); setLoading(false); },
                error: (e) => { setError(e.message); setLoading(false); }
              });
            } catch (e) { setError(e.message); setLoading(false); }
          };

          const getMaturityStatus = (drinkFrom, drinkUntil) => {
            const currentYear = new Date().getFullYear();
            const from = parseInt(drinkFrom); const until = parseInt(drinkUntil);
            if (isNaN(from) || isNaN(until)) return 'Unknown';
            if (currentYear >= from && currentYear <= until) return 'PEAK';
            if (currentYear < from) return 'CELLAR';
            return 'DRINK';
          };

          const getWineColors = (wineType) => {
            const type = wineType?.toLowerCase() || '';
            if (type.includes('red')) return { bg: 'bg-[#FF006E]', accent: 'bg-[#CCFF00]', text: 'text-white', border: 'border-black', glow: 'neon-glow-pink' };
            if (type.includes('white')) return { bg: 'bg-[#CCFF00]', accent: 'bg-white', text: 'text-black', border: 'border-black', glow: 'neon-glow-green' };
            return { bg: 'bg-[#F5E6D3]', accent: 'bg-black', text: 'text-black', border: 'border-black', glow: '' };
          };

          const filterOptions = useMemo(() => {
            return {
              vintage: [...new Set(wines.map(w => w.Vintage).filter(Boolean))].sort((a, b) => b - a),
              wineType: [...new Set(wines.map(w => w['Wine type']).filter(Boolean))].sort(),
              cepage: [...new Set(wines.map(w => w['C√©page']).filter(Boolean))].sort(),
              region: [...new Set(wines.map(w => w.Region).filter(Boolean))].sort(),
              country: [...new Set(wines.map(w => w.Country).filter(Boolean))].sort()
            };
          }, [wines]);

          const filteredWines = useMemo(() => {
            return wines.filter(wine => {
              const matchesSearch = !searchTerm || wine.Producer?.toLowerCase().includes(searchTerm.toLowerCase()) || wine['C√©page']?.toLowerCase().includes(searchTerm.toLowerCase());
              const matchesVintage = !filters.vintage.length || filters.vintage.includes(wine.Vintage);
              const matchesType = !filters.wineType.length || filters.wineType.includes(wine['Wine type']);
              const matchesCepage = !filters.cepage.length || filters.cepage.includes(wine['C√©page']);
              const matchesMaturity = !filters.maturity.length || filters.maturity.includes(getMaturityStatus(wine['Drink From'], wine['Drink Until']));
              const matchesVivino = !filters.vivinoRating || parseFloat(wine['Vivino Rating']) >= 4.0;
              return matchesSearch && matchesVintage && matchesType && matchesCepage && matchesMaturity && matchesVivino;
            });
          }, [wines, searchTerm, filters]);

          const toggleFilter = (cat, val) => setFilters(prev => ({ ...prev, [cat]: prev[cat].includes(val) ? prev[cat].filter(v => v !== val) : [...prev[cat], val] }));

          if (loading) return <div className="min-h-screen bg-[#F5E6D3] flex items-center justify-center font-display text-4xl animate-pulse">LOADING RAVE CAVE...</div>;

          return (
            <div className="min-h-screen bg-[#F5E6D3]">
              <header className="border-b-8 border-black bg-white sticky top-0 z-40 p-6 flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <WineIcon className="w-12 h-12 text-[#FF006E]" />
                  <h1 className="text-5xl font-display text-[#FF006E]">RAVE CAVE</h1>
                </div>
                <input type="text" placeholder="SEARCH..." className="flex-1 max-w-xl mx-8 p-4 bg-black border-4 border-black font-mono text-[#CCFF00] uppercase focus:border-[#FF006E] outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                <div className="font-display text-3xl">{filteredWines.length} BTL</div>
              </header>

              <div className="flex">
                <aside className="w-64 bg-black p-4 space-y-6 sticky top-[100px] h-[calc(100vh-100px)] overflow-y-auto">
                   <h2 className="text-[#CCFF00] font-display text-2xl border-b-2 border-[#CCFF00] mb-4">FILTERS</h2>
                   <FilterSection title="TYPE" options={filterOptions.wineType} selected={filters.wineType} onToggle={val => toggleFilter('wineType', val)} />
                   <FilterSection title="GRAPE" options={filterOptions.cepage} selected={filters.cepage} onToggle={val => toggleFilter('cepage', val)} />
                   <FilterSection title="VINTAGE" options={filterOptions.vintage} selected={filters.vintage} onToggle={val => toggleFilter('vintage', val)} />
                </aside>

                <main className="flex-1 p-8 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                  {filteredWines.map((wine, i) => (
                    <WineCard key={i} wine={wine} onClick={() => setSelectedWine(wine)} getMaturityStatus={getMaturityStatus} getWineColors={getWineColors} />
                  ))}
                </main>
              </div>
              <ChatWidget />
              {selectedWine && <WineModal wine={selectedWine} onClose={() => setSelectedWine(null)} getMaturityStatus={getMaturityStatus} getWineColors={getWineColors} />}
            </div>
          );
        };

        const FilterSection = ({ title, options, selected, onToggle }) => (
          <div className="space-y-2">
            <h3 className="text-[#FF006E] font-mono text-xs uppercase tracking-widest">{title}</h3>
            {options.map(opt => (
              <label key={opt} className="flex items-center gap-2 cursor-pointer group">
                <input type="checkbox" checked={selected.includes(opt)} onChange={() => onToggle(opt)} className="w-4 h-4" />
                <span className="text-white font-mono text-xs group-hover:text-[#CCFF00] uppercase">{opt}</span>
              </label>
            ))}
          </div>
        );

        const WineCard = ({ wine, onClick, getMaturityStatus, getWineColors }) => {
          const colors = getWineColors(wine['Wine type']);
          const maturity = getMaturityStatus(wine['Drink From'], wine['Drink Until']);
          return (
            <div onClick={onClick} className={`cursor-pointer border-8 ${colors.border} ${colors.bg} p-6 card-hover overflow-hidden relative`}>
              <div className="font-display text-7xl text-white tracking-tighter leading-none mb-2">{wine['C√©page']}</div>
              <div className="font-display text-4xl text-white opacity-90">{wine.Vintage}</div>
              <div className="font-mono text-lg text-white opacity-70 mt-4 uppercase">{wine.Producer}</div>
              <div className="mt-4 flex gap-2">
                 <div className="bg-black text-[#CCFF00] px-3 py-1 font-mono text-xs border-2 border-black">{maturity}</div>
                 <div className="bg-white text-black px-3 py-1 font-mono text-xs border-2 border-black">QTY: {wine.Quantity || 1}</div>
              </div>
            </div>
          );
        };

        const WineModal = ({ wine, onClose, getMaturityStatus, getWineColors }) => (
          <div className="fixed inset-0 bg-black/95 flex items-center justify-center p-8 z-50" onClick={onClose}>
            <div className="bg-[#F5E6D3] border-8 border-black max-w-4xl w-full p-12 relative" onClick={e => e.stopPropagation()}>
              <button onClick={onClose} className="absolute top-6 right-6 text-4xl">√ó</button>
              <h2 className="font-display text-8xl leading-none text-[#FF006E]">{wine['Wine name']}</h2>
              <div className="font-display text-9xl text-[#CCFF00]">{wine.Vintage}</div>
              <div className="grid grid-cols-2 gap-4 mt-8">
                {Object.entries(wine).map(([k, v]) => v && <div key={k} className="border-2 border-black p-4 bg-white"><div className="text-[10px] font-mono text-[#FF006E]">{k}</div><div className="font-mono">{v}</div></div>)}
              </div>
            </div>
          </div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<RaveCave />);
    </script>
</body>
</html>
